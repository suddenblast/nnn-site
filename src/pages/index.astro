---
import BaseLayout from "../layouts/BaseLayout.astro";
import { strapiGet } from "../lib/strapi";
import HeroStory from "../components/HeroStory.astro";
import StoryCard from "../components/StoryCard.astro";

/* -----------------------------
   STORIES
----------------------------- */
type Story = {
  slug: string;
  headline: string;
  dek?: string;
  airDate?: string;
  featured?: boolean;
  thumbnail?: any;
  videoUrl?: string;
  section?: string;
};

type StoriesResponse = { data: Story[] };

const { data } = await strapiGet(
  "/api/stories?sort=airDate:desc&pagination[pageSize]=50&populate[0]=thumbnail&populate[1]=section"
);

const stories = data.filter((s: any) => s.slug);
const hero = stories.find((s: any) => s.featured) ?? stories[0] ?? null;
const latest = hero
  ? stories.filter((s: any) => s.slug !== hero.slug).slice(0, 12)
  : stories.slice(0, 12);

/* -----------------------------
   WEATHER (NWS)
----------------------------- */
const LAT = 42.0451;
const LON = -87.6877;

const pointRes = await fetch(`https://api.weather.gov/points/${LAT},${LON}`, {
  headers: { "User-Agent": "NNN Weather (nnn@northwestern.edu)" },
});
const pointData = await pointRes.json();

const forecastUrl = pointData?.properties?.forecast;

let periods: any[] = [];
if (forecastUrl) {
  const forecastRes = await fetch(forecastUrl, {
    headers: { "User-Agent": "NNN Weather (nnn@northwestern.edu)" },
  });
  const forecastData = await forecastRes.json();
  periods = forecastData?.properties?.periods ?? [];
}

const emojiFor = (text = "") => {
  const t = text.toLowerCase();
  if (t.includes("thunder") || t.includes("storm")) return "‚õàÔ∏è";
  if (t.includes("snow") || t.includes("blizzard") || t.includes("flurr")) return "‚ùÑÔ∏è";
  if (t.includes("rain") || t.includes("shower") || t.includes("drizzle")) return "üåßÔ∏è";
  if (t.includes("fog") || t.includes("haze") || t.includes("smoke")) return "üå´Ô∏è";
  if (t.includes("wind")) return "üí®";
  if (t.includes("sun") || t.includes("clear")) return "‚òÄÔ∏è";
  if (t.includes("partly")) return "üå§Ô∏è";
  if (t.includes("cloud")) return "‚òÅÔ∏è";
  return "üå°Ô∏è";
};

// Current-ish = first period
const now = periods[0] ?? null;

// 10 daytime periods (label says 7-day)
const tenDay = periods.filter((p) => p?.isDaytime).slice(0, 10);

/* -----------------------------
   SOCIALS
----------------------------- */
const socials = [
  { label: "Instagram", emoji: "üì∏", href: "https://www.instagram.com/nnn_news/" },
  { label: "X (Twitter)", emoji: "ùïè", href: "https://x.com/nnn_news" },
  { label: "TikTok", emoji: "üéµ", href: "https://www.tiktok.com/@northwesternnewsnetwork" },
  { label: "YouTube", emoji: "‚ñ∂Ô∏è", href: "https://www.youtube.com/@northwesternnewsnetwork" },
  { label: "Facebook", emoji: "üìò", href: "https://www.facebook.com/nnntv" },
];
---

<BaseLayout title="NNN">
  <div class="grid">
    <div style="display:grid; gap:14px;">
      {hero && <HeroStory story={hero} />}

      <section>
        <div class="section-title">Latest</div>
        <div class="list">
          {latest.map((s: any) => <StoryCard story={s} />)}
        </div>
      </section>
    </div>

    <aside class="sidebar" style="display:grid; gap:14px; align-content:start;">
      <!-- Weather Card -->
      <section class="card" style="height: fit-content;">
        <div class="card-pad">
          <div class="section-title">Evanston Weather</div>

          {now ? (
            <>
              <div style="display:flex; align-items:baseline; justify-content:space-between; gap:12px;">
                <div style="font-weight:900; font-size:15px;">
                  {emojiFor(now.shortForecast)} {now.shortForecast}
                </div>
                <div style="font-weight:950; font-size:18px;">
                  {now.temperature}¬∞
                </div>
              </div>

              <div style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px;">
                <div
                  style="
                    font-weight:900;
                    font-size:12px;
                    letter-spacing:.02em;
                    text-transform:uppercase;
                    color:var(--muted2);
                  "
                >
                  7-Day Forecast
                </div>

                <div style="margin-top:8px; display:grid; gap:8px;">
                  {tenDay.map((p: any) => (
                    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                      <div style="min-width:84px; font-weight:850;">
                        {p.name}
                      </div>

                      <div
                        style="
                          flex:1;
                          color:var(--muted);
                          font-size:13px;
                          display:-webkit-box;
                          -webkit-line-clamp: 1;
                          -webkit-box-orient: vertical;
                          overflow:hidden;
                        "
                      >
                        {emojiFor(p.shortForecast)} {p.shortForecast}
                      </div>

                      <div style="font-weight:900;">
                        {p.temperature}¬∞
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </>
          ) : (
            <div style="color:var(--muted); font-size:14px;">
              Weather unavailable
            </div>
          )}

          <div style="margin-top:10px; font-size:12px; color:var(--muted2);">
            Source: National Weather Service
          </div>
        </div>
      </section>

      <!-- Follow Us Card -->
      <section class="card">
        <div class="card-pad">
          <div class="section-title">Follow NNN</div>
          <div style="color:var(--muted); font-size:14px; margin-top:2px;">
            Get the latest clips + updates.
          </div>

          <div style="margin-top:10px; display:grid; gap:8px;">
            {socials.map((s: any) => (
              <a
                class="storycard"
                href={s.href}
                target="_blank"
                rel="noopener noreferrer"
                style="padding:10px 12px; align-items:center;"
              >
                <div style="display:flex; align-items:center; gap:10px; width:100%;">
                  <div style="font-size:18px; line-height:1;">
                    {s.emoji}
                  </div>

                  <div style="flex:1;">
                    <div style="font-weight:900;">
                      {s.label}
                    </div>
                  </div>

                  <div style="color:var(--accent2); font-weight:850;">‚Üí</div>
                </div>
              </a>
            ))}
          </div>
        </div>
      </section>
    </aside>
  </div>
</BaseLayout>
