---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { strapiGet } from "../../lib/strapi";
import { norm, staffByline } from "../../lib/normalize";
import { toEmbedUrl } from "../../lib/video";

export const prerender = false;

interface Story {
  id: number;
  headline?: string;
  slug?: string;
  publishedAt?: string;
  staff?: any;
}

/* Page param */
const { slug } = Astro.params;
if (!slug) return Astro.redirect("/shows");

/* -----------------------------
   1) Fetch show (+ logo + EP)
----------------------------- */
const showRes = await strapiGet(
  `/api/shows` +
    `?filters[slug][$eq]=${encodeURIComponent(slug)}` +
    `&populate[0]=logo` +
    `&populate[1]=ep`
);

const showRaw = showRes?.data?.[0];
if (!showRaw) return Astro.redirect("/shows");

const show = norm(showRaw);
const showId = show?.id ?? null;
const showName = show?.name ?? "Untitled show";

// Logo (media) normalization
const cover =
  show?.logo?.url ??
  show?.logo?.data?.attributes?.url ??
  show?.logo?.data?.url;

const coverAlt =
  show?.logo?.alternativeText ??
  show?.logo?.data?.attributes?.alternativeText ??
  showName;

// Full broadcast embed
const heroEmbed = toEmbedUrl(show.heroVideoUrl);

/* -----------------------------
   EP normalization
----------------------------- */
const relToArray = (rel: any): any[] => {
  if (!rel) return [];
  if (Array.isArray(rel)) return rel;
  if (rel?.data) return Array.isArray(rel.data) ? rel.data : [rel.data];
  return [rel];
};

const getName = (p: any): string => p?.name ?? p?.attributes?.name ?? "";

const epList = relToArray(show?.ep)
  .map((p: any) => (p?.attributes ? p.attributes : p))
  .filter(Boolean);

const epText = epList
  .map((p: any) => getName(p))
  .filter(Boolean)
  .join(", ");

/* -----------------------------
   2) Fetch stories belonging to this show
----------------------------- */
let stories = [];

if (showId) {
  try {
    const storiesRes = await strapiGet("/api/stories", {
      sort: "publishedAt:desc",
      "pagination[pageSize]": 200,
      fields: ["headline", "slug", "publishedAt"],
      populate: "*",
    });

    stories = (storiesRes?.data ?? [])
      .map(norm)
      .filter((s: any) => {
        const rels = [
          ...relToArray(s.show),
          ...relToArray(s.shows),
        ]
          .map((r: any) => norm(r))
          .filter(Boolean);

        return rels.some((r: any) => r?.id === showId);
      });
  } catch (err) {
    console.error("Failed to load stories for show", err);
  }
}

const storyHref = (s: Story): string => `/stories/${s.slug}`;

/* -----------------------------
   BYLINES (no date)
----------------------------- */
---

<BaseLayout title={`${showName} · NNN`}>
  <article class="card">
    {cover ? (
      <div class="hero-media">
        <img src={cover} alt={coverAlt} loading="eager" />
      </div>
    ) : null}

    <div class="card-pad">
      <div class="kicker">
        <span class="pill">Show</span>
        <span>{slug}</span>
      </div>

      <h1 class="h1">{showName}</h1>

      {epText ? (
        <div class="story-meta" style="margin-top:6px;">
          EP: {epText}
        </div>
      ) : null}

      {show?.description ? <p class="dek">{show.description}</p> : null}

      <div style="margin-top:12px;">
        <a class="btn" href="/shows">← All shows</a>
      </div>
    </div>
  </article>

  {heroEmbed ? (
    <section class="card card-pad" style="margin-top:16px;">
      <div class="section-title">Full Broadcast</div>

      <div class="embed">
        <div class="embed-inner">
          <iframe
            src={heroEmbed}
            title={`${showName} – Full Broadcast`}
            loading="lazy"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
          />
        </div>
      </div>
    </section>
  ) : null}

  <section class="card card-pad" style="margin-top:16px;">
    <div class="section-title">Stories</div>

    {stories.length === 0 ? (
      <p class="dek" style="margin:0;">No stories linked to this show yet.</p>
    ) : (
      <div class="list">
        {stories.map((s: any) => {
          const headline = s.headline ?? "Untitled story";

          if (!s.slug) {
            return (
              <div class="storycard" style="align-items:center;">
                <div style="flex:1;">
                  <div class="story-title">{headline}</div>
                  <div class="story-meta">Missing slug</div>
                </div>
              </div>
            );
          }

          const by = staffByline(s.staff);

          return (
            <a class="storycard" href={storyHref(s)}>
              <div style="flex:1;">
                <div class="story-title">{headline}</div>

                {by ? <div class="story-meta">{by}</div> : <div class="story-meta">By NNN Staff</div>}

                <div style="margin-top:8px; font-weight:850; color: var(--accent2);">
                  Read story →
                </div>
              </div>
            </a>
          );
        })}
      </div>
    )}
  </section>
</BaseLayout>
