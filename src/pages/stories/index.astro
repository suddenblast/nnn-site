---
export const prerender = false;

import BaseLayout from "../../layouts/BaseLayout.astro";
import { strapiGet } from "../../lib/strapi";
import { sectionLabel } from "../../lib/normalize";
import StoryCard from "../../components/StoryCard.astro";

type Story = {
  slug: string;
  headline: string;
  dek?: string;
  airDate?: string;
  featured?: boolean;
  videoUrl?: string;
  section?: string;
  thumbnail?: any;
};

type StoriesResponse = { data: Story[] };

const { data } = await strapiGet(
  "/api/stories?sort=airDate:desc&pagination[pageSize]=200&populate[0]=thumbnail&populate[1]=section"
);

const storiesRaw = data.filter((s: any) => s.slug);

const slugify = (text: string) =>
  text
    .toLowerCase()
    .trim()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "");

const selectedSection = Astro.url.searchParams.get("section") ?? "";

const sectionOptions = Array.from(
  storiesRaw.reduce((map: Map<string, string>, story) => {
    const label = sectionLabel(story.section);
    if (!label) return map;
    const slug = slugify(label);
    if (!slug || map.has(slug)) return map;
    map.set(slug, label);
    return map;
  }, new Map<string, string>())
).map(([slug, label]) => ({ slug, label }));

const stories = selectedSection
  ? storiesRaw.filter((s) => slugify(sectionLabel(s.section)) === selectedSection)
  : storiesRaw;
---

<BaseLayout title="Stories • NNN">
  <div style="display:flex; align-items:baseline; justify-content:space-between; gap:12px; flex-wrap:wrap; margin: 6px 0 14px;">
    <div>
      <div class="section-title">Stories</div>
      <div style="color:var(--muted); font-weight:650;">All recent stories from NNN.</div>
    </div>
    <a class="btn" href="/">Back to Home →</a>
  </div>

  <section>
    {sectionOptions.length > 0 && (
      <div
        class="story-filters"
        style="display:flex; flex-wrap:wrap; gap:8px; margin: 2px 0 12px;"
      >
        <a class:list={["pill", !selectedSection && "active"]} href="/stories">
          All
        </a>
        {sectionOptions.map((opt) => (
          <a
            class:list={["pill", selectedSection === opt.slug && "active"]}
            href={`/stories/?section=${opt.slug}`}
          >
            {opt.label}
          </a>
        ))}
      </div>
    )}

    <div class="list">
      {stories.map((s: any) => <StoryCard story={s} />)}
    </div>
  </section>
</BaseLayout>
