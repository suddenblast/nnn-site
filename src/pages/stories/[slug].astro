---
export const prerender = false;

import BaseLayout from "../../layouts/BaseLayout.astro";
import { strapiGet } from "../../lib/strapi";
import {
  norm,
  staffBylineParts,
  imageUrl,
  imageAlt,
  sectionLabel,
  absoluteMediaUrl,
} from "../../lib/normalize";
import { toEmbedUrl } from "../../lib/video";

const { slug } = Astro.params;
if (!slug) return Astro.redirect("/stories");

/* -----------------------------
   Fetch story (SSR-safe)
----------------------------- */
const storyRes = await strapiGet(
  `/api/stories` +
    `?filters[slug][$eq]=${encodeURIComponent(slug)}` +
    `&populate[0]=staff` +
    `&populate[1]=thumbnail` +
    `&populate[2]=section`
);

const storyRaw = storyRes?.data?.[0];
if (!storyRaw) return Astro.redirect("/stories");

const story = norm(storyRaw);
const section = sectionLabel(story?.section);

const headline = story?.headline ?? "Untitled story";
const dek = story?.dek ?? "";

/* -----------------------------
   Thumbnail
----------------------------- */
const thumb = imageUrl(story.thumbnail);
const finalThumb = absoluteMediaUrl(thumb);

/* -----------------------------
   Staff byline
----------------------------- */
const bylineParts = staffBylineParts(story.staff);

/* -----------------------------
   Media
----------------------------- */
const cover =
  absoluteMediaUrl(
    imageUrl(story?.coverImage) ??
      story?.coverImage?.data?.url ??
      null
  );

const coverAlt = imageAlt(story?.coverImage, headline);

const embed = toEmbedUrl(
  story?.videoUrl ?? story?.videoURL ?? story?.video ?? null
);

/* -----------------------------
   Rich text body (blocks or string)
----------------------------- */
const body = story?.articleBody ?? story?.body ?? null;
---

<BaseLayout title={`${headline} · NNN`}>
  <article class="card">
    {cover && (
      <div class="hero-media">
        <img src={cover} alt={coverAlt} loading="eager" />
      </div>
    )}

    <div class="card-pad">
      <div class="kicker">
        <span class="pill">Story</span>
        {section && <span class="pill">{section}</span>}
      </div>

      <h1 class="h1">{headline}</h1>

      <div class="story-meta story-byline" style="margin-top:6px;">
        {bylineParts.length ? (
          <>
            <span>By </span>
            {bylineParts.map((p, i) => (
              <>
                {p.slug ? (
                  <a class="byline-link" href={`/team/${p.slug}/`}>{p.name}</a>
                ) : (
                  <span>{p.name}</span>
                )}
                {p.role && <span> • {p.role}</span>}
                {i < bylineParts.length - 1 && <span>, </span>}
              </>
            ))}
          </>
        ) : (
          "By NNN Staff"
        )}
      </div>

      {dek && <p class="dek">{dek}</p>}

      <div style="margin-top:12px;">
        <a class="btn" href="/stories">← All stories</a>
      </div>
    </div>
  </article>

  {embed && (
    <section class="card card-pad" style="margin-top:16px;">
      <div class="section-title">Video</div>
      <div class="embed">
        <div class="embed-inner">
          <iframe
            src={embed}
            title={`${headline} – Video`}
            loading="lazy"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
          />
        </div>
      </div>
    </section>
  )}

  {!embed && finalThumb && (
    <section class="card card-pad" style="margin-top:16px;">
      <div class="embed" style="background: transparent;">
        <div class="embed-inner">
          <img src={finalThumb} alt="Story thumbnail" style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover; border-radius:8px;" />
        </div>
      </div>
    </section>
  )}

  <section class="card card-pad" style="margin-top:16px;">
    <div class="section-title">Story</div>

    {typeof body === "string" ? (
      <p class="prose">{body}</p>
    ) : Array.isArray(body) ? (
      <div class="prose">
        {body.map((block) => {
          const children = Array.isArray(block?.children)
            ? block.children
            : [];

          const hasText = children.some((c: any) => (c?.text ?? "").trim());
          if (!hasText) return null;

          const inline = children.map((c: any, i: number) => {
            const text = c?.text ?? "";
            if (!text) return null;
            const content = c?.bold ? <strong>{text}</strong> : text;
            return c?.italic ? <em>{content}</em> : content;
          });

          if (block.type === "heading" || block.type === "h2") {
            return <h2>{inline}</h2>;
          }

          return <p>{inline}</p>;
        })}
      </div>
    ) : (
      <p class="dek" style="margin:0;">
        No story body yet.
      </p>
    )}
  </section>
</BaseLayout>
