---
import { getYouTubeThumb, getYouTubeId } from "../lib/video";
import { imageUrl, sectionLabel, absoluteMediaUrl } from "../lib/normalize";

type Props = {
  story: {
    slug: string;
    headline: string;
    dek?: string;
    airDate?: string;
    videoUrl?: string;
    thumbnail?: any;
    section?: string;
  };
};

const { story } = Astro.props as Props;

const videoThumb = getYouTubeThumb(story.videoUrl, "hq");
const coverThumb = imageUrl(story.thumbnail);
const thumb = videoThumb || coverThumb;

const finalThumb = absoluteMediaUrl(thumb);
const section = sectionLabel(story.section);

const ytId = getYouTubeId(story.videoUrl);

function formatDate(d?: string) {
  if (!d) return "";
  return new Date(d + "T00:00:00").toLocaleDateString("en-US", {
    year: "numeric",
    month: "short",
    day: "numeric",
  });
}
---

<section class="card">
  {finalThumb && (
    <a class="hero-media" href={`/stories/${story.slug}/`} style="display:block; position:relative;">
      <img src={finalThumb} alt={story.headline ?? "Featured story"} loading="lazy" />
      <span class="playbadge" aria-hidden="true">
        ▶ Watch / Read
      </span>
    </a>
  )}

  <div class="card-pad">
    <div class="kicker">
      {section && <span class="pill">{section}</span>}
      <span class="pill">Featured</span>
      {story.airDate && <span>{formatDate(story.airDate)}</span>}
      {story.videoUrl && <span class="pill">Video</span>}
    </div>

    <h1 class="h1">{story.headline}</h1>

    {story.dek && <p class="dek">{story.dek}</p>}

    <a class="btn" href={`/stories/${story.slug}/`}>
      Read story <span aria-hidden="true">→</span>
    </a>
  </div>
</section>
