---
import { getYouTubeThumb } from "../lib/video";
import { imageUrl, sectionLabel, absoluteMediaUrl } from "../lib/normalize";

type Props = {
  story: {
    slug: string;
    headline: string;
    dek?: string;
    airDate?: string;
    videoUrl?: string;
    thumbnail?: any;
    section?: string;
  };
};

const { story } = Astro.props as Props;
const videoThumb = getYouTubeThumb(story.videoUrl, "hq");
const coverThumb = imageUrl(story.thumbnail);
const thumb = coverThumb || videoThumb;
const section = sectionLabel(story.section);
const metaParts: string[] = [];
if (story.airDate) metaParts.push(formatDate(story.airDate));
if (story.videoUrl) metaParts.push("Video");
const metaText = metaParts.join(" â€¢ ");

const finalThumb = absoluteMediaUrl(thumb);

function formatDate(d?: string) {
  if (!d) return "";
  return new Date(d + "T00:00:00").toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
  });
}
---

<a class="storycard" href={`/stories/${story.slug}/`}>
  {finalThumb && (
    <div class="thumb" aria-hidden="true">
      <img src={finalThumb} alt="" loading="lazy" />
    </div>
  )}

  <div style="flex:1; min-width:0;">
    <div class="story-meta" style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
      {section && <span class="pill">{section}</span>}
      {metaText && <span>{metaText}</span>}
    </div>

    <div class="story-title">{story.headline}</div>

    {story.dek && <div class="story-dek">{story.dek}</div>}
  </div>
</a>
