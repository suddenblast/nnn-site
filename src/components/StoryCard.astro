---
import { getYouTubeThumb } from "../lib/video";
import { imageUrl } from "../lib/normalize";
import { STRAPI_ORIGIN } from "../lib/strapi";

type Props = {
  story: {
    slug: string;
    headline: string;
    dek?: string;
    airDate?: string;
    videoUrl?: string;
    thumbnail?: any;
  };
};

const { story } = Astro.props as Props;
const videoThumb = getYouTubeThumb(story.videoUrl, "hq");
const coverThumb = imageUrl(story.thumbnail);
const thumb = videoThumb || coverThumb;

// Absolutize relative URLs
const absolutize = (src: string | null) => {
  if (!src) return null;
  if (src.startsWith("http")) return src;
  if (src.startsWith("/")) return `${STRAPI_ORIGIN}${src}`;
  return src;
};
const finalThumb = absolutize(thumb);

function formatDate(d?: string) {
  if (!d) return "";
  return new Date(d + "T00:00:00").toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
  });
}
---

<a class="storycard" href={`/stories/${story.slug}/`}>
  {finalThumb && (
    <div class="thumb" aria-hidden="true">
      <img src={finalThumb} alt="" loading="lazy" />
    </div>
  )}

  <div style="flex:1; min-width:0;">
    <div class="story-meta">
      {story.airDate ? formatDate(story.airDate) : ""}
      {story.videoUrl ? " â€¢ Video" : ""}
    </div>

    <div class="story-title">{story.headline}</div>

    {story.dek && <div class="story-dek">{story.dek}</div>}
  </div>
</a>
